# This workflow pulls the published seCureLI packages from Pypi & Homebrew & executes them against a test repo
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

# TODO we should rename these to smoke tests but I'd rather hold off on doing that for now
# since renaming the workflow/action might cause us to lose history for executions under the old name
name: Integration Testing

on:
  workflow_call:
  workflow_dispatch:

jobs:
  smoke-testing-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/checkout@v4
        with:
          repository: slalombuild/homebrew-secureli
          path: homebrew-secureli
          ref: main
          fetch-depth: 0

      - name: Setup Bats and bats libs
        uses: bats-core/bats-action@1.5.4

      - name: Install Python 3.9
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Run Unit & Smoke Tests
        env:
          BATS_LIBS_ROOT: /usr/lib
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
          HOMEBREW_NO_INSTALL_FROM_API: 1
        run: |
          pip3 install poetry poethepoet requests jinja2
          poetry install
          poe test
          poe e2e
          python ./scripts/get-secureli-dependencies.py
          brew install --build-from-source ./Formula/secureli.rb
